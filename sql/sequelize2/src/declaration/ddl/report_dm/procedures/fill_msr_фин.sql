CREATE OR REPLACE PROCEDURE report_dm.fill_msr_фин () LANGUAGE plpgsql AS $$ BEGIN
DELETE FROM report_dm.msr_фин;
INSERT INTO report_dm.msr_фин (
        договор_id,
        вид_реал_id,
        дата,
        док_нач_id,
        опл_id,
        акт_с,
        акт_по,
        начисл,
        погаш_оплатой_без_аванса,
        погаш_оплатой_аванс,
        погаш_из_перепл,
        погаш_из_аванса,
        погаш_оплатой,
        погаш_из_кред,
        погаш,
        погаш_без_аванса,
        опл_кред_перепл,
        опл_кред_аванс,
        сторно_кред_перепл,
        обор_кред,
        опл_кред,
        сторно_кред,
        долг,
        долг_кред,
        долг_деб
    ) with x1 as (
        SELECT договор_id,
            вид_реал_id,
            дата,
            док_нач_id,
            начисл,
            NULL::int4 AS опл_id,
            NULL::numeric AS погаш_оплатой_без_аванса,
            NULL::numeric AS погаш_оплатой_аванс,
            NULL::numeric AS погаш_из_перепл,
            NULL::numeric AS погаш_из_аванса,
            NULL::numeric AS погаш_оплатой,
            NULL::numeric AS погаш_из_кред,
            NULL::numeric AS погаш,
            NULL::numeric AS погаш_без_аванса,
            NULL::numeric AS опл_кред_перепл,
            NULL::numeric AS опл_кред_аванс,
            NULL::numeric AS сторно_кред_перепл,
            NULL::numeric AS обор_кред,
            NULL::numeric AS опл_кред,
            NULL::numeric AS сторно_кред,
            дата AS акт_с,
            дата AS акт_по,
            NULL::numeric AS долг,
            NULL::numeric AS долг_кред,
            NULL::numeric AS долг_деб
        FROM report_dm.msr_фин_начисл
        UNION ALL
        SELECT договор_id,
            вид_реал_id,
            дата,
            док_нач_id,
            NULL AS начисл,
            опл_id,
            погаш_оплатой_без_аванса,
            погаш_оплатой_аванс,
            погаш_из_перепл,
            погаш_из_аванса,
            погаш_оплатой,
            погаш_из_кред,
            погаш,
            погаш_без_аванса,
            NULL AS опл_кред_перепл,
            NULL AS опл_кред_аванс,
            NULL AS сторно_кред_перепл,
            NULL AS обор_кред,
            NULL AS опл_кред,
            NULL AS сторно_кред,
            дата AS акт_с,
            дата AS акт_по,
            NULL AS долг,
            NULL AS долг_кред,
            NULL AS долг_деб
        FROM report_dm.msr_фин_опл_погаш
        UNION ALL
        SELECT договор_id,
            вид_реал_id,
            дата,
            NULL AS док_нач_id,
            NULL AS начисл,
            опл_id,
            NULL AS погаш_оплатой_без_аванса,
            NULL AS погаш_оплатой_аванс,
            NULL AS погаш_из_перепл,
            NULL AS погаш_из_аванса,
            NULL AS погаш_оплатой,
            NULL AS погаш_из_кред,
            NULL AS погаш,
            NULL AS погаш_без_аванса,
            опл_кред_перепл,
            опл_кред_аванс,
            сторно_кред_перепл,
            обор_кред,
            опл_кред,
            сторно_кред,
            дата AS акт_с,
            дата AS акт_по,
            NULL AS долг,
            NULL AS долг_кред,
            NULL AS долг_деб
        FROM report_dm.msr_фин_опл_кредит
        UNION ALL
        SELECT договор_id,
            вид_реал_id,
            акт_с as дата,
            NULL as док_нач_id,
            NULL AS начисл,
            NULL AS опл_id,
            NULL AS погаш_оплатой_без_аванса,
            NULL AS погаш_оплатой_аванс,
            NULL AS погаш_из_перепл,
            NULL AS погаш_из_аванса,
            NULL AS погаш_оплатой,
            NULL AS погаш_из_кред,
            NULL AS погаш,
            NULL AS погаш_без_аванса,
            NULL AS опл_кред_перепл,
            NULL AS опл_кред_аванс,
            NULL AS сторно_кред_перепл,
            NULL AS обор_кред,
            NULL AS опл_кред,
            NULL AS сторно_кред,
            акт_с,
            акт_по,
            долг,
            долг_кред,
            долг_деб
        FROM report_dm.msr_фин_сальдо_по_дог_вид_реал
    )
select договор_id,
    вид_реал_id,
    дата,
    док_нач_id,
    опл_id,
    акт_с,
    акт_по,
    sum(начисл) начисл,
    sum(погаш_оплатой_без_аванса) погаш_оплатой_без_аванса,
    sum(погаш_оплатой_аванс) погаш_оплатой_аванс,
    sum(погаш_из_перепл) погаш_из_перепл,
    sum(погаш_из_аванса) погаш_из_аванса,
    sum(погаш_оплатой) погаш_оплатой,
    sum(погаш_из_кред) погаш_из_кред,
    sum(погаш) погаш,
    sum(погаш_без_аванса) погаш_без_аванса,
    sum(опл_кред_перепл) опл_кред_перепл,
    sum(опл_кред_аванс) опл_кред_аванс,
    sum(сторно_кред_перепл) сторно_кред_перепл,
    sum(обор_кред) обор_кред,
    sum(опл_кред) опл_кред,
    sum(сторно_кред) сторно_кред,
    sum(долг) долг,
    sum(долг_кред) долг_кред,
    sum(долг_деб) долг_деб
from x1
group by договор_id,
    вид_реал_id,
    дата,
    док_нач_id,
    опл_id,
    акт_с,
    акт_по;
commit;
END;
$$;